version: '3.8'

services:
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: jobapplier-ai
    ports:
      - "8001:8001"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      PORT: 8001
    networks:
      - jobapplier-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8001/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 5

  jobspy-service:
    build:
      context: ./jobspy-service
      dockerfile: Dockerfile
    container_name: jobapplier-jobspy
    ports:
      - "8002:8002"
    networks:
      - jobapplier-network
    restart: unless-stopped
    environment:
      PYTHONUNBUFFERED: "1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: jobapplier-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      PORT: 8080
      AI_SERVICE_URL: http://ai-service:8001
      CORS_ALLOWED_ORIGINS: http://localhost:5173
      JOBSPY_SERVICE_URL: http://jobspy-service:8002
    depends_on:
      ai-service:
        condition: service_healthy
      jobspy-service:
        condition: service_started
    networks:
      - jobapplier-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: /api
        VITE_AI_SERVICE_URL: /ai
    container_name: jobapplier-frontend
    ports:
      - "5173:8080"
    depends_on:
      - backend
    networks:
      - jobapplier-network
    restart: unless-stopped

networks:
  jobapplier-network:
    driver: bridge